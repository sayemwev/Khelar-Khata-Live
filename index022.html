<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶≤‡¶æ‡¶á‡¶≠ ‡¶∏‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶∏ ‡¶ì ‡¶∏‡ßç‡¶ï‡ßã‡¶∞</title>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #3b82f6; --danger: #ef4444; --accent: #22c55e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        
        /* Video Player Area */
        .video-container { 
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; 
            background: #000; border-radius: 12px; margin-bottom: 15px; border: 2px solid #334155;
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; pointer-events: auto; }
        
        /* Unmute Overlay Button */
        .unmute-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 10; cursor: pointer;
            transition: opacity 0.3s;
        }
        .unmute-btn {
            background: var(--danger); color: white; padding: 15px 25px;
            font-size: 1.2rem; border-radius: 50px; border: 2px solid white;
            animation: pulse 1.5s infinite;
        }
        .hidden { display: none !important; }

        .no-video { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b; }

        /* Scoreboard */
        .scoreboard { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5); }
        .score-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 10px; }
        .main-score { font-size: 3rem; font-weight: 800; color: var(--text); line-height: 1; }
        .wickets { font-size: 1.5rem; color: var(--danger); vertical-align: super; }
        .details { font-size: 1.1rem; color: #94a3b8; }
        .status { background: #334155; padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; color: #fbbf24; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Login & Admin */
        .login-box { margin-top: 50px; padding: 20px; background: var(--card); border-radius: 10px; }
        input { padding: 12px; width: 70%; border-radius: 6px; border: 1px solid #475569; background: #0f172a; color: white; margin-bottom: 10px; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--accent); }
        
        #admin-panel { display: none; text-align: left; background: #111; padding: 15px; border-radius: 10px; border: 1px solid #444; margin-top: 20px; }
        .control-section { margin-bottom: 20px; padding: 15px; background: #222; border-radius: 8px; }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .btn-control { padding: 15px; font-size: 1.2rem; background: #333; color: white; border: 1px solid #555; border-radius: 5px; cursor: pointer; }
        .tips { font-size: 0.85rem; color: #fbbf24; background: #451a03; padding: 10px; border-radius: 5px; margin-top: 10px; }
        
        .admin-trigger { position: fixed; bottom: 10px; right: 10px; opacity: 0.3; font-size: 0.8rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="margin:0;"><i class="fas fa-satellite-dish"></i> ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ñ‡ßá‡¶≤‡¶æ</h2>
        <div id="connection-status" style="font-size:0.8rem; color:var(--accent);"></div>
    </div>

    <!-- Video Player -->
    <div class="video-container" id="video-wrapper">
        <div class="no-video" id="video-placeholder">
            <i class="fas fa-play-circle fa-3x"></i><br>‡¶≤‡¶æ‡¶á‡¶≠ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
        </div>
        <!-- Overlay for Sound -->
        <div id="sound-overlay" class="unmute-overlay hidden" onclick="enableSound()">
            <div class="unmute-btn"><i class="fas fa-volume-up"></i> ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        </div>
    </div>

    <!-- Scoreboard -->
    <div class="scoreboard">
        <div class="score-row">
            <div>
                <span class="main-score" id="score-runs">0</span>
                <span class="wickets">/<span id="score-wickets">0</span></span>
            </div>
            <div style="text-align: right;">
                <div class="status" id="match-status">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®</div>
            </div>
        </div>
        <div class="details">
            ‡¶ì‡¶≠‡¶æ‡¶∞: <span id="score-overs" style="color:var(--primary); font-weight:bold;">0.0</span> 
            | ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü: <span id="score-target">-</span>
        </div>
    </div>

    <!-- Login -->
    <div class="login-box" id="viewer-login">
        <h3><i class="fas fa-users"></i> ‡¶¶‡¶∞‡ßç‡¶∂‡¶ï ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <p style="color:#aaa;">‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®:</p>
        <input type="text" id="join-code" placeholder="‡¶ï‡ßã‡¶°...">
        <button class="btn btn-blue" onclick="joinStream()">‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <h2 style="color:var(--accent); text-align:center;">‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
        <div class="control-section" style="text-align:center;">
            <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶°:</p>
            <h1 id="my-admin-id" style="color:var(--primary); letter-spacing: 5px; margin:5px;">...</h1>
        </div>

        <div class="control-section">
            <label>üé• ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¨‡¶æ <b>Embed Code</b>:</label>
            <input type="text" id="video-url-input" style="width:100%; box-sizing:border-box;" placeholder="Facebook/YouTube ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¨‡¶æ <iframe...> ‡¶ï‡ßã‡¶°">
            <button class="btn btn-green" style="width:100%; margin-top:5px;" onclick="updateVideoLink()">‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <div class="tips">
                <strong>‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂:</strong><br>
                ‡ßß. ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶∞ <b>Share > Embed</b> ‡¶Ö‡¶™‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶° ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡ßá‡¶∞‡¶æ ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§<br>
                ‡ß®. ‡¶¶‡¶∞‡ßç‡¶∂‡¶ï‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶™‡ßá‡¶§‡ßá "Unmute" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
            </div>
        </div>

        <div class="control-section">
            <label>üèè ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü:</label>
            <div class="btn-grid">
                <button class="btn-control" onclick="updateScore(0)">0</button>
                <button class="btn-control" onclick="updateScore(1)">1</button>
                <button class="btn-control" onclick="updateScore(2)">2</button>
                <button class="btn-control" onclick="updateScore(3)">3</button>
                <button class="btn-control" onclick="updateScore(4)">4</button>
                <button class="btn-control" onclick="updateScore(6)">6</button>
                <button class="btn-control" onclick="updateScore('WD')">WD</button>
                <button class="btn-control" style="background:var(--danger);" onclick="updateScore('W')">OUT</button>
            </div>
            <div style="margin-top:10px;">
                <input type="text" id="status-text" placeholder="‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏..." style="width:60%;">
                <button class="btn btn-blue" style="width:35%;" onclick="updateStatusMsg()">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>
            </div>
        </div>
    </div>

    <div class="admin-trigger" onclick="enableAdmin()">Admin</div>
</div>

<script>
    let peer;
    let connections = [];
    let matchState = {
        runs: 0, wickets: 0, balls: 0, overs: "0.0", target: "-", status: "‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ö‡¶≤‡¶õ‡ßá",
        videoType: null, videoSrc: null
    };

    // --- Admin Functions ---
    function enableAdmin() {
        const pass = prompt("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°:");
        if(!pass) return;
        document.getElementById('viewer-login').classList.add('hidden');
        document.getElementById('admin-panel').style.display = 'block';
        const adminId = Math.floor(1000 + Math.random() * 9000).toString();
        document.getElementById('my-admin-id').innerText = adminId;
        
        peer = new Peer(adminId);
        peer.on('connection', conn => {
            connections.push(conn);
            conn.on('open', () => conn.send(matchState));
        });
    }

    function broadcast() {
        connections.forEach(conn => { if(conn.open) conn.send(matchState); });
        renderUI(matchState);
    }

    function updateScore(val) {
        if (val === 'W') { matchState.wickets++; matchState.balls++; }
        else if (val === 'WD') { matchState.runs++; } 
        else { matchState.runs += val; matchState.balls++; }
        matchState.overs = Math.floor(matchState.balls / 6) + "." + (matchState.balls % 6);
        broadcast();
    }
    
    function updateStatusMsg() { matchState.status = document.getElementById('status-text').value; broadcast(); }

    function updateVideoLink() {
        let input = document.getElementById('video-url-input').value.trim();
        if(!input) return alert("‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡¶®!");

        let type = "";
        let src = "";

        // 1. Raw Embed Code Check (Best for Facebook)
        if (input.includes("<iframe") || input.includes("facebook.com/plugins")) {
            const srcMatch = input.match(/src="([^"]+)"/);
            if (srcMatch && srcMatch[1]) {
                src = srcMatch[1];
                type = 'raw';
            } else if(input.startsWith("http")) {
                src = input;
                type = 'raw';
            }
        } 
        // 2. YouTube
        else if (input.includes("youtube") || input.includes("youtu.be")) {
            const ytMatch = input.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
            if(ytMatch) { type = 'yt'; src = ytMatch[1]; }
        }
        // 3. Facebook Direct Link
        else if (input.includes("facebook.com") || input.includes("fb.watch")) {
            type = 'fb';
            src = encodeURIComponent(input.replace("m.facebook", "www.facebook").replace("web.facebook", "www.facebook"));
        }

        if(src) {
            matchState.videoType = type;
            matchState.videoSrc = src;
            broadcast();
            alert("‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        } else {
            alert("‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá ‡¶®‡¶æ‡•§ Embed Code ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
    }

    // --- Viewer Functions ---
    function joinStream() {
        const code = document.getElementById('join-code').value;
        if(!code) return alert("‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®!");
        document.getElementById('connection-status').innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        
        peer = new Peer();
        peer.on('open', () => {
            const conn = peer.connect(code);
            conn.on('open', () => {
                document.getElementById('viewer-login').classList.add('hidden');
                document.getElementById('connection-status').innerText = "üü¢ ‡¶≤‡¶æ‡¶á‡¶≠";
            });
            conn.on('data', data => renderUI(data));
        });
    }

    // --- UI Renderer ---
    function renderUI(data) {
        document.getElementById('score-runs').innerText = data.runs;
        document.getElementById('score-wickets').innerText = data.wickets;
        document.getElementById('score-overs').innerText = data.overs;
        document.getElementById('match-status').innerText = data.status;
        document.getElementById('score-target').innerText = data.target;

        const wrapper = document.getElementById('video-wrapper');
        const overlay = document.getElementById('sound-overlay');
        
        if (!data.videoSrc) return;

        // Check if video is already playing to PREVENT RELOADING on score update
        const currentIframe = wrapper.querySelector('iframe');
        
        // Construct new URL based on type
        let newSrcUrl = "";
        let iframeHTML = "";

        if (data.videoType === 'yt') {
            // Force Mute initially for autoplay support
            newSrcUrl = `https://www.youtube.com/embed/${data.videoSrc}?autoplay=1&mute=1&controls=1&playsinline=1`;
            iframeHTML = `<iframe src="${newSrcUrl}" allowfullscreen allow="autoplay; encrypted-media"></iframe>`;
        } 
        else if (data.videoType === 'fb') {
            newSrcUrl = `https://www.facebook.com/plugins/video.php?href=${data.videoSrc}&show_text=false&t=0&autoplay=true&muted=true`;
            iframeHTML = `<iframe src="${newSrcUrl}" scrolling="no" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>`;
        }
        else if (data.videoType === 'raw') {
            newSrcUrl = data.videoSrc;
            // Hack to ensure autoplay params exist in raw url
            if(!newSrcUrl.includes("autoplay")) newSrcUrl += "&autoplay=1";
            if(!newSrcUrl.includes("muted")) newSrcUrl += "&muted=1";
            
            iframeHTML = `<iframe src="${newSrcUrl}" width="100%" height="100%" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>`;
        }

        // If video is already correct, DO NOT reload (prevents glitching)
        if(currentIframe && currentIframe.src === newSrcUrl) {
            return; 
        }

        // Load new video
        document.getElementById('video-placeholder').style.display = 'none';
        
        // Insert Iframe
        if(iframeHTML) {
            // Remove old iframe but keep overlay
            const oldFrame = wrapper.querySelector('iframe');
            if(oldFrame) oldFrame.remove();
            
            wrapper.insertAdjacentHTML('afterbegin', iframeHTML);
            
            // Show "Enable Sound" overlay for viewer
            overlay.classList.remove('hidden');
        }
    }

    // Click to Unmute Logic
    function enableSound() {
        const overlay = document.getElementById('sound-overlay');
        overlay.classList.add('hidden'); // Hide overlay
        alert("‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶∞ ‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶¨‡¶æ‡¶ü‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶¨‡¶æ‡ßú‡¶æ‡¶® (YouTube/Facebook ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶≠‡¶≤‡¶ø‡¶â‡¶Æ ‡¶Ü‡¶á‡¶ï‡¶® ‡¶Ü‡¶õ‡ßá)‡•§");
    }
</script>
</body>
</html>
